<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.onetouch.dao.ProductDao">

<resultMap id="productWithHashtags" type="product">
    <id property="product_idx" column="product_idx"/>
    <result property="category_idx" column="category_idx"/>
    <result property="product_wishlist" column="product_wishlist"/>
    <result property="product_price" column="product_price"/>
    <result property="product_name" column="product_name"/>
    <result property="product_brand" column="product_brand"/>
    <result property="product_comment" column="product_comment"/>
    <result property="product_cnt" column="product_cnt"/>
    <result property="product_time" column="product_time"/>
    <result property="product_update" column="product_update"/>
    <result property="category_name" column="category_name"/>
    
    <!-- HashtagVo ê°ì²´ë¡œ -->
    <collection property="hashtag_list" 
                ofType="hashtag" 
                column="product_idx" 
                select="selectHashtagsByProduct"/>
</resultMap>

	<!-- ìƒí’ˆë³„ í•´ì‹œíƒœê·¸ ì¡°íšŒ-->
	<select id="selectHashtagsByProduct" parameterType="int" resultType="hashtag">
	    select h.hashtag_idx, h.hashtag_name, h.hashtag_time, h.use_count
	    from hashtag h
	    inner join product_hashtag ph on h.hashtag_idx = ph.hashtag_idx
	    where ph.product_idx = #{product_idx}
	    order by h.hashtag_idx
	</select>
	
	<!-- ì—¬ëŸ¬ idxë¡œ ìƒí’ˆ ì¡°íšŒ -->
	<select id="selectByIds" parameterType="list" resultMap="productWithHashtags">
	    select 
	        p.product_idx,
	        p.category_idx,
	        p.product_wishlist,
	        p.product_price,
	        p.product_name,
	        p.product_brand,
	        p.product_comment,
	        p.product_cnt,
	        p.product_time,
	        p.product_update,
	        c.category_name,
	        pi.product_image_url
	    from product p
	    left join category c on p.category_idx = c.category_idx
	    left join (
        select product_idx, product_image_url 
        from product_image 
        where product_image_level = 1
	    ) pi on p.product_idx = pi.product_idx
	    where p.product_idx in
	    <foreach collection="list" item="id" open="(" separator="," close=")">
	        #{id}
	    </foreach>
	    order by p.product_cnt desc
	</select>

    <!-- ê´€ë¦¬ìžìš© ìƒí’ˆ ëª©ë¡ ì¡°íšŒ (íŽ˜ì´ì§• í¬í•¨) -->
    <select id="selectListAdmin" parameterType="map" resultType="product">
	    SELECT
	        p.*,
	        c.category_name,
	        (
	            SELECT pi.product_image_url
	            FROM product_image pi
	            WHERE pi.product_idx = p.product_idx
	            ORDER BY pi.product_image_idx ASC
	            LIMIT 1
	        ) AS product_image_url
	    FROM product p
	    LEFT JOIN category c ON p.category_idx = c.category_idx
	    <where>
	        <if test="keyword != null and keyword != ''">
	            AND (
	                p.product_name LIKE CONCAT('%', #{keyword}, '%')
	                OR p.product_brand LIKE CONCAT('%', #{keyword}, '%')
	                OR p.product_comment LIKE CONCAT('%', #{keyword}, '%')
	                OR c.category_name LIKE CONCAT('%', #{keyword}, '%')
	                OR CAST(p.product_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
	                OR CAST(p.category_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
	                OR CAST(p.product_price AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
	                OR CAST(p.product_cnt AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
	            )
	        </if>
	    </where>
	    ORDER BY p.product_idx DESC
	    <if test="startRow != null and pageSize != null">
	        LIMIT #{startRow}, #{pageSize}
	    </if>
	</select>
	   
	<select id="selectList" parameterType="map" resultMap="productWithHashtags">
	    SELECT 
	        p.product_idx,
	        p.product_name,
	        p.product_brand,
	        p.product_comment,
	        p.product_price,
	        p.product_cnt,
	        p.product_time,
	        p.product_update,
	        p.category_idx,
	        p.product_wishlist,
	        c.category_name,
	        pi.product_image_url
	    FROM product p
	    LEFT JOIN category c ON p.category_idx = c.category_idx
	    LEFT JOIN (
	        SELECT product_idx, product_image_url 
	        FROM product_image 
	        WHERE product_image_level = 1
	    ) pi ON p.product_idx = pi.product_idx
	    
	    <where>
	        <if test="keyword != null and keyword != ''">
	            AND (
	                p.product_name LIKE CONCAT('%', #{keyword}, '%')
	                OR p.product_brand LIKE CONCAT('%', #{keyword}, '%')
	                OR p.product_comment LIKE CONCAT('%', #{keyword}, '%')
	                OR EXISTS (
	                    SELECT 1 
	                    FROM product_hashtag ph
	                    INNER JOIN hashtag h ON ph.hashtag_idx = h.hashtag_idx
	                    WHERE ph.product_idx = p.product_idx
	                      AND h.hashtag_name LIKE CONCAT('%', #{keyword}, '%')
	                )
	            )
	        </if>
	        <if test="category_idx != null and category_idx != ''">
	            AND p.category_idx = #{category_idx}
	        </if>
	    </where>
	    
	    <!-- ORDER BY ì²˜ë¦¬ -->
	    <choose>
			    <when test="orderBy != null and orderBy != ''">
			        <choose>
			            <when test="orderBy.contains('product_price')">
			                ORDER BY CAST(p.product_price AS SIGNED) 
			                <if test="orderBy.contains('ASC')">ASC</if>
			                <if test="orderBy.contains('DESC')">DESC</if>
			            </when>
			            <otherwise>
			                ORDER BY ${orderBy}
			            </otherwise>
			        </choose>
			    </when>
			    <otherwise>
			        ORDER BY p.product_idx DESC
			    </otherwise>
			</choose>
	    

	    
	    <!-- íŽ˜ì´ì§• ì²˜ë¦¬ -->
	    <if test="startRow != null and pageSize != null">
	        LIMIT #{startRow}, #{pageSize}
	    </if>
	</select>
	
	<!-- ë² ìŠ¤íŠ¸ ìƒí’ˆ ì¡°íšŒ 3ê°œ -->
	<select id="selectListbest" parameterType="map" resultMap="productWithHashtags">
    SELECT 
        p.product_idx,
        p.product_name,
        p.product_brand,
        p.product_comment,
        p.product_price,
        p.product_cnt,
        p.product_time,
        p.product_update,
        p.category_idx,
        p.product_wishlist,
        p.product_sell, <!-- íŒë§¤ëŸ‰ ì¶”ê°€ -->
        c.category_name,
        pi.product_image_url
    FROM product p
    LEFT JOIN category c ON p.category_idx = c.category_idx
    LEFT JOIN (
        SELECT product_idx, product_image_url 
        FROM product_image 
        WHERE product_image_level = 1
    ) pi ON p.product_idx = pi.product_idx

    <where>
        <if test="keyword != null and keyword != ''">
            AND (
                p.product_name LIKE CONCAT('%', #{keyword}, '%')
                OR p.product_brand LIKE CONCAT('%', #{keyword}, '%')
                OR p.product_comment LIKE CONCAT('%', #{keyword}, '%')
                OR EXISTS (
                    SELECT 1 
                    FROM product_hashtag ph
                    INNER JOIN hashtag h ON ph.hashtag_idx = h.hashtag_idx
                    WHERE ph.product_idx = p.product_idx
                      AND h.hashtag_name LIKE CONCAT('%', #{keyword}, '%')
                )
            )
        </if>

        <if test="category_idx != null and category_idx != ''">
            AND p.category_idx = #{category_idx}
        </if>
    </where>

    <!-- ORDER BY ì²˜ë¦¬ -->
    <choose>
        <when test="orderBy != null and orderBy != ''">

            <choose>

                <!-- ê°€ê²© ì •ë ¬ -->
                <when test="orderBy.contains('product_price')">
                    ORDER BY CAST(p.product_price AS SIGNED) 
                    <if test="orderBy.contains('ASC')">ASC</if>
                    <if test="orderBy.contains('DESC')">DESC</if>
                </when>

                <!-- ðŸ”¥ product_sell ì •ë ¬ ì¶”ê°€ -->
                <when test="orderBy.contains('product_sell')">
                    ORDER BY p.product_sell
                    <if test="orderBy.contains('ASC')">ASC</if>
                    <if test="orderBy.contains('DESC')">DESC</if>
                </when>

                <otherwise>
                    <if test="orderBy!=null">
                        ORDER BY ${orderBy}
                    </if>
                    <if test="newOrderBy!=null">
                        ORDER BY ${bestOrderBy}
                    </if>
                </otherwise>

            </choose>

        </when>

        <otherwise>
            ORDER BY p.product_idx DESC
        </otherwise>
    </choose>

    <!-- íŽ˜ì´ì§• ì²˜ë¦¬ -->
    <if test="startRow != null and pageSize != null">
        LIMIT #{startRow}, #{pageSize}
    </if>

</select>
	
	
	<!-- ìƒí’ˆ ì´ ê°œìˆ˜ ì¡°íšŒ (í•´ì‹œíƒœê·¸ í¬í•¨ ê²€ìƒ‰) -->
	<select id="selectCount" parameterType="map" resultType="int">
	    SELECT COUNT(DISTINCT p.product_idx)
	    FROM product p
	    LEFT JOIN category c ON p.category_idx = c.category_idx
	    <where>
	        <if test="keyword != null and keyword != ''">
	            AND (
	                p.product_name LIKE CONCAT('%', #{keyword}, '%')
	                OR p.product_brand LIKE CONCAT('%', #{keyword}, '%')
	                OR p.product_comment LIKE CONCAT('%', #{keyword}, '%')
	                OR EXISTS (
	                    SELECT 1 
	                    FROM product_hashtag ph
	                    INNER JOIN hashtag h ON ph.hashtag_idx = h.hashtag_idx
	                    WHERE ph.product_idx = p.product_idx
	                      AND h.hashtag_name LIKE CONCAT('%', #{keyword}, '%')
	                )
	            )
	        </if>
	        <if test="category_idx != null and category_idx != ''">
	            AND p.category_idx = #{category_idx}
	        </if>
	    </where>
	</select>


	<select id="selectMainImage" parameterType="int" resultType="string">
	    SELECT product_image_url 
	    FROM product_image 
	    WHERE product_idx = #{product_idx} AND product_image_level = 1 
	    LIMIT 1
	</select>
	
	<!-- ìƒí’ˆ ì´ë¯¸ì§€ ìˆœì„œëŒ€ë¡œ ê°€ì ¸ì™€ì„œ ì¸ë„¤ì¼ë¡œ ë³´ì—¬ì¤˜ -->
	<select id="selectProductImages" resultType="map">
    SELECT product_image_idx, product_idx, product_image_name, product_image_level
    FROM product_image 
    WHERE product_idx = #{product_idx}
    ORDER BY product_image_level ASC
	</select>

	<!-- ìƒí’ˆ ìƒì„¸íŽ˜ì´ì§€ì—ì„œ level = -1 -2 -3 ì•Œê¸°ìœ„í•´ ì¡°íšŒ -->
	<select id="selectProductImageProductIdxList" parameterType="int" resultType="product">
	    SELECT *
	    FROM product_image 
	    WHERE product_idx = #{product_idx} and 0 > product_image_level order by product_image_idx desc
	</select>
	        
	        
	<select id="selectOne" parameterType="int" resultMap="productWithHashtags">
	    SELECT 
	        p.*,
	        (SELECT product_image_url FROM product_image WHERE product_idx = p.product_idx AND product_image_level = 1 LIMIT 1) as product_image_url,
	        c.category_name
	    FROM product p
	    LEFT JOIN category c ON p.category_idx = c.category_idx
	    WHERE p.product_idx = #{product_idx}
	</select>
		
	<!-- detail ì´ë¯¸ì§€ë“¤ 2 3 4 5 ë ˆë²¨ ì¡°íšŒ -->
	<select id="selectDetailImages" parameterType="int" resultType="String">
	    SELECT product_image_url
	    FROM product_image
	    WHERE product_idx = #{product_idx} 
	    AND product_image_level >= 2
	    ORDER BY product_image_level
	</select>

	<!-- ìƒí’ˆ ìƒì„¸íŽ˜ì´ì§€ lowerdetailImages ì´ë¯¸ì§€ë“¤ ì¡°íšŒ -->
	<select id="selectLowerDetailImages" parameterType="int" resultType="String">
	    SELECT product_image_url
	    FROM product_image
	    WHERE product_idx = #{product_idx} 
	    AND 0 > product_image_level
	    ORDER BY product_image_level
	</select>
	
	<!-- ìƒí’ˆ ìƒì„¸íŽ˜ì´ì§€ upperdetailImages ì´ë¯¸ì§€ë“¤ ì¡°íšŒ -->
	<select id="selectUpperDetailImages" parameterType="int" resultType="String">
	    SELECT product_image_url
	    FROM product_image
	    WHERE product_idx = #{product_idx} 
	    AND  product_image_level > 1
	    ORDER BY product_image_level
	</select>
	<!-- ìƒí’ˆ ì´ë¯¸ì§€ ë ˆë²¨ 1 ë¶ˆëŸ¬ì˜¤ê¸° ë©”ì¸ ì´ë¯¸ì§€ -->
	<select id="selectProductImageLevel1" resultType="product">
		SELECT * FROM product_image
		WHERE product_idx=#{product_idx} and product_image_level =1
	</select>
	
	<!-- ìƒí’ˆ ì‚­ì œì‹œ ì´ë¯¸ì§€ ì„œë²„ì—ì„œ íŒŒì¼ ì‚­ì œí•˜ê¸°ìœ„í•´ì„œ  ìœ„í•´ì„œ ìƒí’ˆ ì´ë¦„ ì¡°íšŒ  -->
	<select id="selectProductImageListName" resultType="product">
		SELECT product_image_url , product_image_level
		FROM product_image
		WHERE product_idx = #{product_idx}
	</select>
	

    <!-- ìƒí’ˆ ë“±ë¡ -->
    <insert id="insert" parameterType="product" useGeneratedKeys="true" keyProperty="product_idx">
        INSERT INTO product (
            category_idx, 
            product_wishlist, 
            product_price, 
            product_name, 
            product_brand, 
            product_comment, 
            product_cnt, 
            product_time, 
            product_update
        )
        VALUES (
            #{category_idx},
            0,
            #{product_price},
            #{product_name},
            #{product_brand},
            #{product_comment},
            #{product_cnt},
            NOW(),
            NOW()
        )
    </insert>
	<!-- ì´ë¯¸ì§€ ë“±ë¡  -->
	
    <insert id="insertProductImage" parameterType="product">
    INSERT INTO product_image (
        product_idx,
        product_image_url,
        product_image_level
    )
    VALUES (
        #{product_idx},
        #{product_image_url},
        #{product_image_level}  
    )
	</insert>

    <!-- ìƒí’ˆ ìˆ˜ì • -->
    <update id="update" parameterType="product">
        UPDATE product
        SET
            product_name = #{product_name},
            product_price = #{product_price},
            product_comment = #{product_comment},
            product_brand = #{product_brand},
            product_cnt = #{product_cnt},
            category_idx = #{category_idx},
            product_update = CURRENT_TIMESTAMP
        WHERE product_idx = #{product_idx}
    </update>

    <!-- ìƒí’ˆ ì´ë¯¸ì§€ ìˆ˜ì • -->
    <update id="updateProductImage" parameterType="product">
        UPDATE product_image
        SET product_image_url = #{product_image_url}
        WHERE product_idx = #{product_idx}
        AND product_image_level = 1
    </update>
    
    <!-- ìƒí’ˆ ì„œë¸Œ ì´ë¯¸ì§€ ì‚­ì œ -->
	<delete id="deleteProductSubImages">
		DELETE FROM product_image
		WHERE product_idx=#{product_idx} AND product_image_level >1;
	</delete>
    <!-- ìƒí’ˆ ë‚´ìš© ì´ë¯¸ì§€ ì‚­ì œ -->
	<delete id="deleteProductContentImages">
		DELETE FROM product_image
		WHERE product_idx=#{product_idx} AND 0 > product_image_level;
	</delete>

    <!-- ìƒí’ˆ ì‚­ì œ -->
    <delete id="delete" parameterType="int">
        DELETE FROM product
        WHERE product_idx = #{product_idx}
    </delete>
    
    <delete id="deleteProductRemainOne" parameterType="int">
        DELETE FROM product_remain
        WHERE product_idx = #{product_idx}
    </delete>

    <!-- ìƒí’ˆ ì¼ê´„ ì‚­ì œ -->
    <delete id="deleteBatch" parameterType="list">
        DELETE FROM product
        WHERE product_idx IN
        <foreach item="id" collection="list" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    <!-- ìƒí’ˆ ì¼ê´„ ì‚­ì œì „ remain ì‚­ì œ -->
    <delete id="deleteProductRemain" parameterType="list">
    	DELETE FROM product_remain
        WHERE product_idx IN
        <foreach item="id" collection="list" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    
    <!-- ê´€ë¦¬ìžìš© ìƒí’ˆ ì´ ê°œìˆ˜ ì¡°íšŒ (í†µí•© ê²€ìƒ‰) -->
	<select id="selectCountAdmin" parameterType="map" resultType="int">
	    SELECT COUNT(DISTINCT product.product_idx)
	    FROM product
	    LEFT JOIN category ON product.category_idx = category.category_idx
	    LEFT JOIN product_image ON product.product_idx = product_image.product_idx
	    <where>
	        <if test="keyword != null and keyword != ''">
	            AND (
	                <!-- ìƒí’ˆ ì •ë³´ -->
	                product.product_name LIKE CONCAT('%', #{keyword}, '%')
	                OR product.product_brand LIKE CONCAT('%', #{keyword}, '%')
	                OR product.product_comment LIKE CONCAT('%', #{keyword}, '%')
	                
	                <!-- ì¹´í…Œê³ ë¦¬ëª… -->
	                OR category.category_name LIKE CONCAT('%', #{keyword}, '%')
	                
	                <!-- ìˆ«ìž í•„ë“œë“¤ (ë¬¸ìžì—´ë¡œ ë³€í™˜í•˜ì—¬ ê²€ìƒ‰) -->
	                OR CAST(product.product_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
	                OR CAST(product.category_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
	                OR CAST(product.product_price AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
	                OR CAST(product.product_cnt AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
	                
	                <!-- ì´ë¯¸ì§€ URL -->
	                OR product_image.product_image_url LIKE CONCAT('%', #{keyword}, '%')
	            )
	        </if>
	    </where>
	</select>


	<!-- ìž¬ê³  ë“±ë¡ -->
	<insert id="insertRemain" parameterType="product">
	    INSERT INTO product_remain (product_idx, remain_name, remain_cnt, remain_regdate)
	    VALUES (#{product_idx}, #{remain_name}, #{remain_cnt}, NOW())
	</insert>
	
	<!-- íŠ¹ì • ìƒí’ˆì˜ ìž¬ê³  ì´ë ¥ ì¡°íšŒ -->
	<select id="selectRemainListByProduct" parameterType="int" resultType="product">
	    SELECT remain_idx, product_idx, remain_name, remain_cnt, remain_regdate
	    FROM product_remain
	    WHERE product_idx = #{product_idx}
	    ORDER BY remain_regdate DESC
	</select>
	
	<!-- ì „ì²´ ìž¬ê³  ì´ë ¥ ì¡°íšŒ (íŽ˜ì´ì§•) -->
	<select id="selectRemainList" parameterType="map" resultType="product">
	    SELECT remain_idx, product_idx, remain_name, remain_cnt, remain_regdate
	    FROM product_remain
	    <where>
	        <if test="product_idx != null">
	            AND product_idx = #{product_idx}
	        </if>
	    </where>
	    ORDER BY remain_regdate DESC
	    <if test="startRow != null and pageSize != null">
	        LIMIT #{startRow}, #{pageSize}
	    </if>
	</select>
	
	<!-- ìž¬ê³  ì´ë ¥ ì´ ê°œìˆ˜ -->
	<select id="selectRemainCount" parameterType="map" resultType="int">
	    SELECT COUNT(*)
	    FROM product_remain
	    <where>
	        <if test="product_idx != null">
	            AND product_idx = #{product_idx}
	        </if>
	    </where>
	</select>
	
		<!-- ìƒí’ˆ ì´ë¯¸ì§€ ì¶”ê°€ -->
		<insert id="uploadImages" parameterType="com.onetouch.vo.ProductVo">
		    INSERT INTO product_image (
		    	product_idx,
		        product_image_url,
		        product_image_level
		    ) VALUES (
		    	#{product_idx},
		        #{product_image_url},
		        #{product_image_level}
		    )
		</insert>
	
	<!-- ë©”ì¸ ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ -->
	<update id="updateMainProductImage" parameterType="map">
	    UPDATE product
	    SET product_image_url = #{product_image_url},
	        product_update = NOW()
	    WHERE product_idx = #{product_idx}
	</update>
	
	<!-- ìƒì„¸ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ -->
	<update id="updateProductImageByIdx" parameterType="map">
	    UPDATE product_image
	    SET product_image_url = #{product_image_url}
	    WHERE product_image_idx = #{product_image_idx}
	</update>
	
	<!-- ìƒì„¸ ì´ë¯¸ì§€ ì‚­ì œ -->
	<delete id="deleteProductImageByIdx" parameterType="int">
	    DELETE FROM product_image
	    WHERE product_image_idx = #{product_image_idx}
	</delete>
	
	<!-- íŒŒì¼ëª…ìœ¼ë¡œ ì´ë¯¸ì§€ ì‚­ì œ -->
	<delete id="deleteContentImage" parameterType="String">
	    DELETE FROM product_image
	    WHERE product_image_url = #{product_image_url}
	</delete>
	
	<!-- íŒë§¤ì‹œ ìž¬ê³ ,íŒë§¤ëŸ‰ ì—…ë°ì´íŠ¸ -->	
	<update id="updateStockAndSell">
	    UPDATE product 
	    SET product_sell = product_sell + #{count},
	        product_cnt = product_cnt - #{count}
	    WHERE product_idx = #{product_idx}
	      AND product_cnt >= #{count} 
	</update>

</mapper>