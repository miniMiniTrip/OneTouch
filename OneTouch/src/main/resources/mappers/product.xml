<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.onetouch.dao.ProductDao">
   
    <select id="selectListAdmin" parameterType="map" resultType="product">
        SELECT
            product.*,
            category.category_name,
            product_image.product_image_url
        FROM product
        LEFT JOIN category ON product.category_idx = category.category_idx
        LEFT JOIN product_image ON product.product_idx = product_image.product_idx
        <where>
            <if test="keyword != null and keyword != ''">
                AND (
                    <!-- ìƒí’ˆ ì •ë³´ -->
                    product.product_name LIKE CONCAT('%', #{keyword}, '%')
                    OR product.product_brand LIKE CONCAT('%', #{keyword}, '%')
                    OR product.product_comment LIKE CONCAT('%', #{keyword}, '%')
                    
                    <!-- ì¹´í…Œê³ ë¦¬ëª… -->
                    OR category.category_name LIKE CONCAT('%', #{keyword}, '%')
                    
                    <!-- ìˆ«ìž í•„ë“œë“¤ (ë¬¸ìžì—´ë¡œ ë³€í™˜í•˜ì—¬ ê²€ìƒ‰) -->
                    OR CAST(product.product_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                    OR CAST(product.category_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                    OR CAST(product.product_price AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                    OR CAST(product.product_cnt AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                    
                    <!-- ì´ë¯¸ì§€ URL -->
                    OR product_image.product_image_url LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
        ORDER BY product.product_idx DESC
        <if test="startRow != null and pageSize != null">
            LIMIT #{startRow}, #{pageSize}
        </if>
    </select>
   
    <!-- ðŸ”¥ ê³ ê°ìš© ìƒí’ˆ ëª©ë¡ ì¡°íšŒ (ì •ë ¬ ê¸°ëŠ¥ í¬í•¨) -->
    <select id="selectList" parameterType="map" resultType="product">
        SELECT 
            p.product_idx,
            p.product_name,
            p.product_brand,
            p.product_comment,
            p.product_price,
            p.product_cnt,
            p.product_time,
            p.product_update,
            p.category_idx,
            p.product_wishlist,
            c.category_name,
            pi.product_image_url
        FROM product p
        LEFT JOIN category c ON p.category_idx = c.category_idx
        LEFT JOIN (
            SELECT product_idx, product_image_url 
            FROM product_image 
            WHERE product_image_level = 1
        ) pi ON p.product_idx = pi.product_idx
        
        <where>
            <if test="keyword != null and keyword != ''">
                AND p.product_name LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="category_idx != null and category_idx != ''">
                AND p.category_idx = #{category_idx}
            </if>
        </where>
        
        <!-- â­ ORDER BY ì²˜ë¦¬ -->
        <choose>
            <when test="orderBy != null and orderBy != ''">
                ORDER BY ${orderBy}
            </when>
            <otherwise>
                ORDER BY p.product_idx DESC
            </otherwise>
        </choose>
        
        <!-- íŽ˜ì´ì§• ì²˜ë¦¬ -->
        <if test="startRow != null and pageSize != null">
            LIMIT #{startRow}, #{pageSize}
        </if>
    </select>

    <!-- ìƒí’ˆ ì´ ê°œìˆ˜ ì¡°íšŒ (í†µí•©) -->
    <select id="selectCount" parameterType="map" resultType="int">
        SELECT COUNT(DISTINCT p.product_idx)
        FROM product p
        LEFT JOIN category c ON p.category_idx = c.category_idx
        <where>
            <if test="keyword != null and keyword != ''">
                AND p.product_name LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="category_idx != null and category_idx != ''">
                AND p.category_idx = #{category_idx}
            </if>
        </where>
        </select>


<select id="selectMainImage" parameterType="int" resultType="string">
    SELECT product_image_url 
    FROM product_image 
    WHERE product_idx = #{product_idx} AND product_image_level = 1 
    LIMIT 1
</select>
        
        
 <select id="selectOne" parameterType="int" resultType="product">
    SELECT 
        p.*,
        (SELECT product_image_url FROM product_image WHERE product_idx = p.product_idx AND product_image_level = 1 LIMIT 1) as product_image_url,
        c.category_name
    FROM product p
    LEFT JOIN category c ON p.category_idx = c.category_idx
    WHERE p.product_idx = #{product_idx}
</select>
<!-- detail ì´ë¯¸ì§€ë“¤ ì¡°íšŒ -->
			<select id="selectDetailImages" parameterType="int" resultType="string">
			    SELECT product_image_url
			    FROM product_image
			    WHERE product_idx = #{product_idx} 
			    AND product_image_level >= 2
			    ORDER BY product_image_level
			</select>


    <!-- ìƒí’ˆ ë“±ë¡ -->
    <insert id="insert" parameterType="product" useGeneratedKeys="true" keyProperty="product_idx">
        INSERT INTO product (
            category_idx, 
            product_wishlist, 
            product_price, 
            product_name, 
            product_brand, 
            product_comment, 
            product_cnt, 
            product_time, 
            product_update
        )
        VALUES (
            #{category_idx},
            0,
            #{product_price},
            #{product_name},
            #{product_brand},
            #{product_comment},
            #{product_cnt},
            NOW(),
            NOW()
        )
    </insert>

    <!-- ìƒí’ˆ ì´ë¯¸ì§€ ë“±ë¡ -->
    <insert id="productImageInsert" parameterType="product">
        INSERT INTO product_image (
            product_idx,
            product_image_url,
            product_image_level
        )
        VALUES (
            #{product_idx},
            #{product_image_url},
            1
        )
    </insert>

    <!-- ìƒí’ˆ ìˆ˜ì • -->
    <update id="update" parameterType="product">
        UPDATE product
        SET
            product_name = #{product_name},
            product_price = #{product_price},
            product_comment = #{product_comment},
            product_brand = #{product_brand},
            product_cnt = #{product_cnt},
            category_idx = #{category_idx},
            product_update = CURRENT_TIMESTAMP
        WHERE product_idx = #{product_idx}
    </update>

    <!-- ìƒí’ˆ ì´ë¯¸ì§€ ìˆ˜ì • -->
    <update id="updateProductImage" parameterType="product">
        UPDATE product_image
        SET product_image_url = #{product_image_url}
        WHERE product_idx = #{product_idx}
        AND product_image_level = 1
    </update>

    <!-- ìƒí’ˆ ì‚­ì œ -->
    <delete id="delete" parameterType="int">
        DELETE FROM product
        WHERE product_idx = #{product_idx}
    </delete>

    <!-- ìƒí’ˆ ì¼ê´„ ì‚­ì œ -->
    <delete id="deleteBatch" parameterType="list">
        DELETE FROM product
        WHERE product_idx IN
        <foreach item="id" collection="list" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    <!-- ê´€ë¦¬ìžìš© ìƒí’ˆ ì´ ê°œìˆ˜ ì¡°íšŒ (í†µí•© ê²€ìƒ‰) -->
<select id="selectCountAdmin" parameterType="map" resultType="int">
    SELECT COUNT(DISTINCT product.product_idx)
    FROM product
    LEFT JOIN category ON product.category_idx = category.category_idx
    LEFT JOIN product_image ON product.product_idx = product_image.product_idx
    <where>
        <if test="keyword != null and keyword != ''">
            AND (
                <!-- ìƒí’ˆ ì •ë³´ -->
                product.product_name LIKE CONCAT('%', #{keyword}, '%')
                OR product.product_brand LIKE CONCAT('%', #{keyword}, '%')
                OR product.product_comment LIKE CONCAT('%', #{keyword}, '%')
                
                <!-- ì¹´í…Œê³ ë¦¬ëª… -->
                OR category.category_name LIKE CONCAT('%', #{keyword}, '%')
                
                <!-- ìˆ«ìž í•„ë“œë“¤ (ë¬¸ìžì—´ë¡œ ë³€í™˜í•˜ì—¬ ê²€ìƒ‰) -->
                OR CAST(product.product_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                OR CAST(product.category_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                OR CAST(product.product_price AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                OR CAST(product.product_cnt AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                
                <!-- ì´ë¯¸ì§€ URL -->
                OR product_image.product_image_url LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
    </where>
</select>


<!-- ìž¬ê³  ë“±ë¡ -->
<insert id="insertRemain" parameterType="product">
    INSERT INTO product_remain (product_idx, remain_name, remain_cnt, remain_regdate)
    VALUES (#{product_idx}, #{remain_name}, #{remain_cnt}, NOW())
</insert>

<!-- íŠ¹ì • ìƒí’ˆì˜ ìž¬ê³  ì´ë ¥ ì¡°íšŒ -->
<select id="selectRemainListByProduct" parameterType="int" resultType="product">
    SELECT remain_idx, product_idx, remain_name, remain_cnt, remain_regdate
    FROM product_remain
    WHERE product_idx = #{product_idx}
    ORDER BY remain_regdate DESC
</select>

<!-- ì „ì²´ ìž¬ê³  ì´ë ¥ ì¡°íšŒ (íŽ˜ì´ì§•) -->
<select id="selectRemainList" parameterType="map" resultType="product">
    SELECT remain_idx, product_idx, remain_name, remain_cnt, remain_regdate
    FROM product_remain
    <where>
        <if test="product_idx != null">
            AND product_idx = #{product_idx}
        </if>
    </where>
    ORDER BY remain_regdate DESC
    <if test="startRow != null and pageSize != null">
        LIMIT #{startRow}, #{pageSize}
    </if>
</select>

<!-- ìž¬ê³  ì´ë ¥ ì´ ê°œìˆ˜ -->
<select id="selectRemainCount" parameterType="map" resultType="int">
    SELECT COUNT(*)
    FROM product_remain
    <where>
        <if test="product_idx != null">
            AND product_idx = #{product_idx}
        </if>
    </where>
</select>

    

</mapper>