<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.onetouch.dao.ProductDao">

<resultMap id="productWithHashtags" type="product">
    <id property="product_idx" column="product_idx"/>
    <result property="category_idx" column="category_idx"/>
    <result property="product_wishlist" column="product_wishlist"/>
    <result property="product_price" column="product_price"/>
    <result property="product_name" column="product_name"/>
    <result property="product_brand" column="product_brand"/>
    <result property="product_comment" column="product_comment"/>
    <result property="product_cnt" column="product_cnt"/>
    <result property="product_time" column="product_time"/>
    <result property="product_update" column="product_update"/>
    <result property="category_name" column="category_name"/>
    
    <!-- HashtagVo 객체로 -->
    <collection property="hashtag_list" 
                ofType="hashtag" 
                column="product_idx" 
                select="selectHashtagsByProduct"/>
</resultMap>

	<!-- 상품별 해시태그 조회-->
	<select id="selectHashtagsByProduct" parameterType="int" resultType="hashtag">
	    select h.hashtag_idx, h.hashtag_name, h.hashtag_time, h.use_count
	    from hashtag h
	    inner join product_hashtag ph on h.hashtag_idx = ph.hashtag_idx
	    where ph.product_idx = #{product_idx}
	    order by h.hashtag_idx
	</select>
	
	<!-- 여러 idx로 상품 조회 -->
	<select id="selectByIds" parameterType="list" resultMap="productWithHashtags">
	    select 
	        p.product_idx,
	        p.category_idx,
	        p.product_wishlist,
	        p.product_price,
	        p.product_name,
	        p.product_brand,
	        p.product_comment,
	        p.product_cnt,
	        p.product_time,
	        p.product_update,
	        c.category_name
	    from product p
	    left join category c on p.category_idx = c.category_idx
	    where p.product_idx in
	    <foreach collection="list" item="id" open="(" separator="," close=")">
	        #{id}
	    </foreach>
	    order by p.product_cnt desc
	</select>

    <!-- 관리자용 상품 목록 조회 (페이징 포함) -->
    <select id="selectListAdmin" parameterType="map" resultType="product">
    SELECT
        p.*,
        c.category_name,
        (
            SELECT pi.product_image_url
            FROM product_image pi
            WHERE pi.product_idx = p.product_idx
            ORDER BY pi.product_image_idx ASC
            LIMIT 1
        ) AS product_image_url
    FROM product p
    LEFT JOIN category c ON p.category_idx = c.category_idx
    <where>
        <if test="keyword != null and keyword != ''">
            AND (
                p.product_name LIKE CONCAT('%', #{keyword}, '%')
                OR p.product_brand LIKE CONCAT('%', #{keyword}, '%')
                OR p.product_comment LIKE CONCAT('%', #{keyword}, '%')
                OR c.category_name LIKE CONCAT('%', #{keyword}, '%')
                OR CAST(p.product_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                OR CAST(p.category_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                OR CAST(p.product_price AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                OR CAST(p.product_cnt AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
    </where>
    ORDER BY p.product_idx DESC
    <if test="startRow != null and pageSize != null">
        LIMIT #{startRow}, #{pageSize}
    </if>
</select>
   
    <!-- 고객용 상품 목록 조회 (정렬 기능 포함) -->
	<select id="selectList" parameterType="map" resultMap="productWithHashtags">
	    SELECT 
	        p.product_idx,
	        p.product_name,
	        p.product_brand,
	        p.product_comment,
	        p.product_price,
	        p.product_cnt,
	        p.product_time,
	        p.product_update,
	        p.category_idx,
	        p.product_wishlist,
	        c.category_name,
	        pi.product_image_url
	    FROM product p
	    LEFT JOIN category c ON p.category_idx = c.category_idx
	    LEFT JOIN (
	        SELECT product_idx, product_image_url 
	        FROM product_image 
	        WHERE product_image_level = 1
	    ) pi ON p.product_idx = pi.product_idx
	    
	    <where>
	        <if test="keyword != null and keyword != ''">
	            AND p.product_name LIKE CONCAT('%', #{keyword}, '%')
	        </if>
	        <if test="category_idx != null and category_idx != ''">
	            AND p.category_idx = #{category_idx}
	        </if>
	    </where>
	    
	    <!-- ORDER BY 처리 -->
	    <choose>
	        <when test="orderBy != null and orderBy != ''">
	            ORDER BY ${orderBy}
	        </when>
	        <otherwise>
	            ORDER BY p.product_idx DESC
	        </otherwise>
	    </choose>
	    
	    <!-- 페이징 처리 -->
	    <if test="startRow != null and pageSize != null">
	        LIMIT #{startRow}, #{pageSize}
	    </if>
	</select>

    <!-- 상품 총 개수 조회 (통합) -->
    <select id="selectCount" parameterType="map" resultType="int">
        SELECT COUNT(DISTINCT p.product_idx)
        FROM product p
        LEFT JOIN category c ON p.category_idx = c.category_idx
        <where>
            <if test="keyword != null and keyword != ''">
                AND p.product_name LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="category_idx != null and category_idx != ''">
                AND p.category_idx = #{category_idx}
            </if>
        </where>
        </select>


	<select id="selectMainImage" parameterType="int" resultType="string">
	    SELECT product_image_url 
	    FROM product_image 
	    WHERE product_idx = #{product_idx} AND product_image_level = 1 
	    LIMIT 1
	</select>
	
	<!-- 상품 이미지 순서대로 가져와서 썸네일로 보여줘 -->
	<select id="selectProductImages" resultType="map">
    SELECT product_image_idx, product_idx, product_image_name, product_image_level
    FROM product_image 
    WHERE product_idx = #{product_idx}
    ORDER BY product_image_level ASC
	</select>

	<!-- 상품 상세페이지에서 level = -1 -2 -3 알기위해 조회 -->
	<select id="selectProductImageProductIdxList" parameterType="int" resultType="product">
	    SELECT *
	    FROM product_image 
	    WHERE product_idx = #{product_idx} and 0 > product_image_level order by product_image_idx desc
	</select>
	        
	        
	<select id="selectOne" parameterType="int" resultMap="productWithHashtags">
	    SELECT 
	        p.*,
	        (SELECT product_image_url FROM product_image WHERE product_idx = p.product_idx AND product_image_level = 1 LIMIT 1) as product_image_url,
	        c.category_name
	    FROM product p
	    LEFT JOIN category c ON p.category_idx = c.category_idx
	    WHERE p.product_idx = #{product_idx}
	</select>
		
	<!-- detail 이미지들 2 3 4 5 레벨 조회 -->
	<select id="selectDetailImages" parameterType="int" resultType="String">
	    SELECT product_image_url
	    FROM product_image
	    WHERE product_idx = #{product_idx} 
	    AND product_image_level >= 2
	    ORDER BY product_image_level
	</select>

	<!-- 상품 상세페이지 lowerdetailImages 이미지들 조회 -->
	<select id="selectLowerDetailImages" parameterType="int" resultType="String">
	    SELECT product_image_url
	    FROM product_image
	    WHERE product_idx = #{product_idx} 
	    AND 0 > product_image_level
	    ORDER BY product_image_level
	</select>
	
	<!-- 상품 상세페이지 upperdetailImages 이미지들 조회 -->
	<select id="selectUpperDetailImages" parameterType="int" resultType="String">
	    SELECT product_image_url
	    FROM product_image
	    WHERE product_idx = #{product_idx} 
	    AND  product_image_level > 1
	    ORDER BY product_image_level
	</select>
	<!-- 상품 이미지 레벨 1 불러오기 메인 이미지 -->
	<select id="selectProductImageLevel1" resultType="product">
		SELECT * FROM product_image
		WHERE product_idx=#{product_idx} and product_image_level =1
	</select>
	
	<!-- 상품 삭제시 이미지 서버에서 파일 삭제하기위해서  위해서 상품 이름 조회  -->
	<select id="selectProductImageListName" resultType="product">
		SELECT product_image_url , product_image_level
		FROM product_image
		WHERE product_idx = #{product_idx}
	</select>
	

    <!-- 상품 등록 -->
    <insert id="insert" parameterType="product" useGeneratedKeys="true" keyProperty="product_idx">
        INSERT INTO product (
            category_idx, 
            product_wishlist, 
            product_price, 
            product_name, 
            product_brand, 
            product_comment, 
            product_cnt, 
            product_time, 
            product_update
        )
        VALUES (
            #{category_idx},
            0,
            #{product_price},
            #{product_name},
            #{product_brand},
            #{product_comment},
            #{product_cnt},
            NOW(),
            NOW()
        )
    </insert>
	<!-- 이미지 등록  -->
	
    <insert id="insertProductImage" parameterType="product">
    INSERT INTO product_image (
        product_idx,
        product_image_url,
        product_image_level
    )
    VALUES (
        #{product_idx},
        #{product_image_url},
        #{product_image_level}  
    )
	</insert>

    <!-- 상품 수정 -->
    <update id="update" parameterType="product">
        UPDATE product
        SET
            product_name = #{product_name},
            product_price = #{product_price},
            product_comment = #{product_comment},
            product_brand = #{product_brand},
            product_cnt = #{product_cnt},
            category_idx = #{category_idx},
            product_update = CURRENT_TIMESTAMP
        WHERE product_idx = #{product_idx}
    </update>

    <!-- 상품 이미지 수정 -->
    <update id="updateProductImage" parameterType="product">
        UPDATE product_image
        SET product_image_url = #{product_image_url}
        WHERE product_idx = #{product_idx}
        AND product_image_level = 1
    </update>
    
    <!-- 상품 서브 이미지 삭제 -->
	<delete id="deleteProductSubImages">
		DELETE FROM product_image
		WHERE product_idx=#{product_idx} AND product_image_level >1;
	</delete>
    <!-- 상품 내용 이미지 삭제 -->
	<delete id="deleteProductContentImages">
		DELETE FROM product_image
		WHERE product_idx=#{product_idx} AND 0 > product_image_level;
	</delete>

    <!-- 상품 삭제 -->
    <delete id="delete" parameterType="int">
        DELETE FROM product
        WHERE product_idx = #{product_idx}
    </delete>

    <!-- 상품 일괄 삭제 -->
    <delete id="deleteBatch" parameterType="list">
        DELETE FROM product
        WHERE product_idx IN
        <foreach item="id" collection="list" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    <!-- 관리자용 상품 총 개수 조회 (통합 검색) -->
	<select id="selectCountAdmin" parameterType="map" resultType="int">
	    SELECT COUNT(DISTINCT product.product_idx)
	    FROM product
	    LEFT JOIN category ON product.category_idx = category.category_idx
	    LEFT JOIN product_image ON product.product_idx = product_image.product_idx
	    <where>
	        <if test="keyword != null and keyword != ''">
	            AND (
	                <!-- 상품 정보 -->
	                product.product_name LIKE CONCAT('%', #{keyword}, '%')
	                OR product.product_brand LIKE CONCAT('%', #{keyword}, '%')
	                OR product.product_comment LIKE CONCAT('%', #{keyword}, '%')
	                
	                <!-- 카테고리명 -->
	                OR category.category_name LIKE CONCAT('%', #{keyword}, '%')
	                
	                <!-- 숫자 필드들 (문자열로 변환하여 검색) -->
	                OR CAST(product.product_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
	                OR CAST(product.category_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
	                OR CAST(product.product_price AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
	                OR CAST(product.product_cnt AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
	                
	                <!-- 이미지 URL -->
	                OR product_image.product_image_url LIKE CONCAT('%', #{keyword}, '%')
	            )
	        </if>
	    </where>
	</select>


	<!-- 재고 등록 -->
	<insert id="insertRemain" parameterType="product">
	    INSERT INTO product_remain (product_idx, remain_name, remain_cnt, remain_regdate)
	    VALUES (#{product_idx}, #{remain_name}, #{remain_cnt}, NOW())
	</insert>
	
	<!-- 특정 상품의 재고 이력 조회 -->
	<select id="selectRemainListByProduct" parameterType="int" resultType="product">
	    SELECT remain_idx, product_idx, remain_name, remain_cnt, remain_regdate
	    FROM product_remain
	    WHERE product_idx = #{product_idx}
	    ORDER BY remain_regdate DESC
	</select>
	
	<!-- 전체 재고 이력 조회 (페이징) -->
	<select id="selectRemainList" parameterType="map" resultType="product">
	    SELECT remain_idx, product_idx, remain_name, remain_cnt, remain_regdate
	    FROM product_remain
	    <where>
	        <if test="product_idx != null">
	            AND product_idx = #{product_idx}
	        </if>
	    </where>
	    ORDER BY remain_regdate DESC
	    <if test="startRow != null and pageSize != null">
	        LIMIT #{startRow}, #{pageSize}
	    </if>
	</select>
	
	<!-- 재고 이력 총 개수 -->
	<select id="selectRemainCount" parameterType="map" resultType="int">
	    SELECT COUNT(*)
	    FROM product_remain
	    <where>
	        <if test="product_idx != null">
	            AND product_idx = #{product_idx}
	        </if>
	    </where>
	</select>
	
		<!-- 상품 이미지 추가 -->
		<insert id="uploadImages" parameterType="com.onetouch.vo.ProductVo">
		    INSERT INTO product_image (
		    	product_idx,
		        product_image_url,
		        product_image_level
		    ) VALUES (
		    	#{product_idx},
		        #{product_image_url},
		        #{product_image_level}
		    )
		</insert>
	
	<!-- 메인 상품 이미지 업데이트 -->
	<update id="updateMainProductImage" parameterType="map">
	    UPDATE product
	    SET product_image_url = #{product_image_url},
	        product_update = NOW()
	    WHERE product_idx = #{product_idx}
	</update>
	
	<!-- 상세 이미지 업데이트 -->
	<update id="updateProductImageByIdx" parameterType="map">
	    UPDATE product_image
	    SET product_image_url = #{product_image_url}
	    WHERE product_image_idx = #{product_image_idx}
	</update>
	
	<!-- 상세 이미지 삭제 -->
	<delete id="deleteProductImageByIdx" parameterType="int">
	    DELETE FROM product_image
	    WHERE product_image_idx = #{product_image_idx}
	</delete>
	
	<!-- 파일명으로 이미지 삭제 -->
	<delete id="deleteContentImage" parameterType="String">
	    DELETE FROM product_image
	    WHERE product_image_url = #{product_image_url}
	</delete>

    

</mapper>