<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.onetouch.dao.ProductDao">

    <!-- 상품 목록 조회 (페이징 포함) -->
    <select id="selectList" parameterType="map" resultType="product">
        SELECT
            product.*,
            category.category_name,
            product_image.product_image_url
        FROM product
        LEFT JOIN category ON product.category_idx = category.category_idx
        LEFT JOIN product_image ON product.product_idx = product_image.product_idx
        <where>
            <if test="keyword != null and keyword != ''">
                AND (
                    <!-- 상품 정보 -->
                    product.product_name LIKE CONCAT('%', #{keyword}, '%')
                    OR product.product_brand LIKE CONCAT('%', #{keyword}, '%')
                    OR product.product_comment LIKE CONCAT('%', #{keyword}, '%')
                    
                    <!-- 카테고리명 -->
                    OR category.category_name LIKE CONCAT('%', #{keyword}, '%')
                    
                    <!-- 숫자 필드들 (문자열로 변환하여 검색) -->
                    OR CAST(product.product_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                    OR CAST(product.category_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                    OR CAST(product.product_price AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                    OR CAST(product.product_cnt AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                    
                    <!-- 이미지 URL -->
                    OR product_image.product_image_url LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
        ORDER BY product.product_idx DESC
        <if test="startRow != null and pageSize != null">
            LIMIT #{startRow}, #{pageSize}
        </if>
    </select>

    <!-- 상품 총 개수 조회 -->
    <select id="selectCount" parameterType="map" resultType="int">
        SELECT COUNT(DISTINCT product.product_idx)
        FROM product
        LEFT JOIN category ON product.category_idx = category.category_idx
        LEFT JOIN product_image ON product.product_idx = product_image.product_idx
        <where>
            <if test="keyword != null and keyword != ''">
                AND (
                    product.product_name LIKE CONCAT('%', #{keyword}, '%')
                    OR product.product_brand LIKE CONCAT('%', #{keyword}, '%')
                    OR product.product_comment LIKE CONCAT('%', #{keyword}, '%')
                    OR category.category_name LIKE CONCAT('%', #{keyword}, '%')
                    OR CAST(product.product_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                    OR CAST(product.category_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                    OR CAST(product.product_price AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                    OR CAST(product.product_cnt AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                    OR product_image.product_image_url LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
    </select>

    <select id="selectOne" parameterType="int" resultType="product">
        SELECT 
            p.*,
            pi.product_image_url,
            pi.product_image_idx,
            c.category_name
        FROM product p
        LEFT JOIN product_image pi ON p.product_idx = pi.product_idx
        LEFT JOIN category c ON p.category_idx = c.category_idx
        WHERE p.product_idx = #{product_idx}
        AND (pi.product_image_level = 1 OR pi.product_image_level IS NULL)
    </select>

    <insert id="insert" parameterType="product" useGeneratedKeys="true" keyProperty="product_idx">
        INSERT INTO product (
            category_idx, 
            product_wishlist, 
            product_price, 
            product_name, 
            product_brand, 
            product_comment, 
            product_cnt, 
            product_time, 
            product_update
        )
        VALUES (
            #{category_idx},
            0,
            #{product_price},
            #{product_name},
            #{product_brand},
            #{product_comment},
            #{product_cnt},
            NOW(),
            NOW()
        )
    </insert>

    <insert id="productImageInsert" parameterType="product">
        INSERT INTO product_image (
            product_idx,
            product_image_url,
            product_image_level
        )
        VALUES (
            #{product_idx},
            #{product_image_url},
            1
        )
    </insert>

    <update id="update" parameterType="product">
        UPDATE product
        SET
            product_name = #{product_name},
            product_price = #{product_price},
            product_comment = #{product_comment},
            product_brand = #{product_brand},
            product_cnt = #{product_cnt},
            category_idx = #{category_idx},
            product_update = CURRENT_TIMESTAMP
        WHERE product_idx = #{product_idx}
    </update>

    <update id="updateProductImage" parameterType="product">
        UPDATE product_image
        SET product_image_url = #{product_image_url}
        WHERE product_idx = #{product_idx}
        AND product_image_level = 1
    </update>

    <delete id="delete" parameterType="int">
        DELETE FROM product
        WHERE product_idx = #{product_idx}
    </delete>

    <delete id="deleteBatch" parameterType="list">
        DELETE FROM product
        WHERE product_idx IN
        <foreach item="id" collection="list" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

</mapper>