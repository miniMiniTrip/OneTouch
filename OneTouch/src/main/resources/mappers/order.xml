<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.onetouch.dao.OrderDao">

<insert id="insert" parameterType="order" useGeneratedKeys="true" keyProperty="order_id">
	insert into `order`(
		mem_idx,
		order_no,
		order_status,
		total_amount,
		order_name,
		order_mem_name,
		order_phone,
		order_postal,
		order_address,
		order_address_more,
		order_time
	) values (
		#{mem_idx},
		#{order_no},
		'결제대기',
		#{total_amount},
		#{order_name},
		#{order_mem_name},
		#{order_phone},
		#{order_postal},
		#{order_address},
		#{order_address_more},
		now()
	)
</insert>

<!-- 단건 주문 조회 -->
<select id="selectOne" parameterType="int" resultType="order">
	select * from `order` where order_id = #{order_id}
</select>

<!-- 회원별 주문 목록 조회 -->
<select id="selectList" parameterType="int" resultType="order">
	select * from `order` where mem_idx = #{mem_idx}
	order by order_time desc
</select>

<!-- 주문번호로 조회 -->
<select id="selectOneByOrderNo" parameterType="string" resultType="order">
	select * from `order` o
		left join mem m on o.mem_idx = m.mem_idx
	where o.order_no = #{order_no}
</select>

<!-- parameterType을 int로 변경 -->
<select id="selectOneByOrderId" parameterType="int" resultType="order">
	select * from `order` o
		left join mem m on o.mem_idx = m.mem_idx
	where o.order_id = #{order_id}
</select>

<!-- 주문 내용 수정 -->
<update id="update" parameterType="order">
	update `order` set
		order_mem_name = #{order_mem_name},
		order_phone = #{order_phone},
		order_postal = #{order_postal},
		order_address = #{order_address},
		order_address_more = #{order_address_more},
		order_update = now()
	where order_id = #{order_id}
</update>

<!-- 주문 상태 수정 -->
<update id="updateStatus">
    update `order` set 
        order_status = #{param2},
        order_update = now()
    where order_id = #{param1}
</update>

<!-- 관리자용 쿼리 -->

<!-- 상태 전체 변경 -->
<update id="updateDeliveryInfo" parameterType="map">
    update `order` set
        order_tracking = #{order_tracking},
        order_courier = #{order_courier},
        order_status = #{order_status},
        order_update = now()
    where order_id = #{order_id}
</update>

<!-- 송장 변경 -->
<update id="updateTracking" parameterType="map">
    update `order` set
        order_tracking = #{order_tracking},
        order_courier = #{order_courier},
        order_update = now()
    where order_id = #{order_id}
</update>

<!-- 관리자 모든 오더 조회 -->
<select id="selectAllOrdersforAdmin" parameterType="order">
	select * from `order`
	order by order_time desc
</select>
	
<!-- 배송상태별 조회 -->
<select id="selectOrdersByStatus" parameterType="order">
	select * from `order`
	where order_status = #{order_status}
	order by order_time desc
</select>

<!-- 검색 쿼리문 -->
<select id="searchOrders" parameterType="map" resultType="order">
	select * from `order`
	where 1 = 1
	<if test="searchKeyword != null and searchKeyword != ''">
		and	(order_no like concat ('%', #{searchKeyword}, '%'))
		or order_mem_name like concat ('%', #{searchKeyword}, '%'))
	</if>
	<if test="order_status != null and order_status !=''">
		and order_status = #{order_status}
	</if>
	order by order_time desc
</select>
</mapper>