<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.onetouch.dao.OrderDao">

<insert id="insert" parameterType="order" useGeneratedKeys="true" keyProperty="order_id">
	insert into `order`(
		mem_idx,
		order_no,
		order_status,
		total_amount,
		order_name,
		order_mem_name,
		order_phone,
		order_postal,
		order_address,
		order_address_more,
		order_time
	) values (
		#{mem_idx},
		#{order_no},
		#{order_status},
		#{total_amount},
		#{order_name},
		#{order_mem_name},
		#{order_phone},
		#{order_postal},
		#{order_address},
		#{order_address_more},
		now()
	)
</insert>

<!-- 단건 주문 조회 -->
<select id="selectOne" parameterType="int" resultType="order">
	select * from `order` where order_id = #{order_id}
</select>


<!-- 회원별 주문 목록 조회 -->
<select id="selectList" parameterType="int" resultType="OrderReviewVo">
SELECT 
o.order_id as order_id
,o.order_no as order_no
,o.mem_idx as mem_idx
,o.order_status as order_status
,oi.product_name as product_name
,o.order_time as order_time
,o.total_amount as total_amount
,o.order_address as order_address
,p.order_item_id as order_item_id
,oi.product_idx as product_idx
FROM 
otdb.order o
LEFT JOIN order_item oi ON o.order_id = oi.order_id
LEFT JOIN mem m ON o.mem_idx = m.mem_idx
LEFT JOIN post p ON p.order_item_id = oi.order_item_id
WHERE m.mem_idx = #{mem_idx}
ORDER BY o.order_time desc
;
</select>

<!-- 주문번호로 조회 -->
<select id="selectOneByOrderNo" parameterType="string" resultType="order">
	select * from `order` o
		left join mem m on o.mem_idx = m.mem_idx
	where o.order_no = #{order_no}
</select>

<!-- 주문 ID로 조회 -->
<select id="selectOneByOrderId" parameterType="int" resultType="order">
	select * from `order` where order_id = #{order_id}
</select>

<!-- 주문 상태 업데이트 -->
<update id="updateStatus">
	update `order` 
	set order_status = #{order_status},
	    order_update = now()
	where order_id = #{order_id}
</update>

<!-- 배송 정보 업데이트 -->
<update id="updateDeliveryInfo" parameterType="map">
	update `order`
	set order_status = #{order_status},
	    order_tracking = #{order_tracking},
	    order_courier = #{order_courier},
	    order_update = now()
	where order_id = #{order_id}
</update>

<!-- 송장 번호 업데이트 -->
<update id="updateTracking" parameterType="map">
	update `order`
	set order_tracking = #{order_tracking},
	    order_courier = #{order_courier},
	    order_update = now()
	where order_id = #{order_id}
</update>

<!-- 주문 정보 수정 -->
<update id="update" parameterType="order">
	update `order`
	set order_mem_name = #{order_mem_name},
	    order_phone = #{order_phone},
	    order_postal = #{order_postal},
	    order_address = #{order_address},
	    order_address_more = #{order_address_more},
	    order_update = now()
	where order_id = #{order_id}
</update>

<!-- 관리자: 전체 주문 조회 -->
<select id="selectAllOrdersforAdmin" resultType="order">
	select * from `order`
	order by order_time desc
</select>

<!-- 관리자: 배송 상태별 조회 -->
<select id="selectOrdersByStatus" parameterType="string" resultType="order">
	select * from `order`
	where order_status = #{order_status}
	order by order_time desc
</select>

<!-- 관리자: 검색 -->
<select id="searchOrders" parameterType="map" resultType="order">
	select * from `order`
	where 1=1
	<if test="search_keyword != null and search_keyword != ''">
		and (order_no like concat('%', #{search_keyword}, '%')
		     or order_mem_name like concat('%', #{search_keyword}, '%')
		     or order_phone like concat('%', #{search_keyword}, '%'))
	</if>
	<if test="order_status != null and order_status != ''">
		and order_status = #{order_status}
	</if>
	order by order_time desc
</select>

</mapper>