<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.onetouch.dao.CartDao">
	
	<select id="selectList" resultType="cart">
	select
        c.cart_id,
        c.mem_idx,
        c.product_idx,
        c.cart_cnt,
        c.cart_time,
        p.product_name,
        p.product_price,
        pi.product_image_url,
        (c.cart_cnt * p.product_price) as total_amount
    from cart c
    inner join product p on c.product_idx = p.product_idx
    left join product_image pi on p.product_idx = pi.product_idx 
        and pi.product_image_level = 1
   	where c.mem_idx = #{mem_idx}
    order by c.cart_time desc
	</select>
	
	<select id="selectCartTotalAmount" resultType="int">
		select ifnull(sum(c.cart_cnt * p.product_price),0)
		from cart c
		inner join product p on c.product_idx = p.product_idx
		where c.mem_idx = #{mem_idx}
	</select>
	
	<!-- 중복검사 -->
	<select id="selectCartIdByProduct" resultType="cart">
		select * from cart
		where product_idx = #{product_idx} and mem_idx = #{mem_idx}
	</select>
	
	<!-- 주문서 작성 -->
	<select id="selectPaymentList" parameterType="Map" resultType="cart">
		select
	        c.cart_id,
	        c.mem_idx,
	        c.product_idx,
	        c.cart_cnt,
	        c.cart_time,
	        p.product_name,
	        p.product_price,
	        pi.product_image_url,
	        (c.cart_cnt * p.product_price) as total_amount
	    from cart c
	    inner join product p on c.product_idx = p.product_idx
	    left join product_image pi on p.product_idx = pi.product_idx 
        	and pi.product_image_level = 1
        where c.cart_id in
		<foreach item="cart_id" collection="cart_id_array" open="(" separator="," close=")"> 
			#{ cart_id }
		</foreach>
	</select>
	
	<!-- 주문서 가격 -->
	<select id="selectPaymentTotalAmount" parameterType="Map" resultType="int">
		select ifnull(sum(c.cart_cnt * p.product_price),0)
		from cart c
		inner join product p on c.product_idx = p.product_idx
		where cart_id in
		<foreach item="cart_id" collection="cart_id_array" open="(" separator="," close=")"> 
			#{ cart_id }
		</foreach>
	</select>
	
	<!-- 추가 -->
	
	<insert id="insert" parameterType="cart">
		insert into cart 
			(mem_idx, p_idx, cart_cnt, cart_time)
		values
			(#{ mem_idx }, { p_idx }, #{ cart_cnt }, now())
	</insert>
	
	<!-- 수정 -->
	<update id="update" parameterType="cart">
		update cart set cart_cnt=#{cart_cnt}
		where cart_id=#{cart_id}
	</update>
		
	<!-- 삭제 -->	
	<delete id="delete" parameterType="int">
		delete from cart where cart_id=#{cart_id}
	</delete>

	<delete id="deletePaymentComplete" parameterType="Map">
		delete from cart where
		<foreach item="cart_id" collection="cart_id_array" separator="or">
		cart_id = #{cart_id}
		</foreach>
	</delete>
	
</mapper>

