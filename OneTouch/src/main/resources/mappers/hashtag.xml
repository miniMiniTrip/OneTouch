<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.onetouch.dao.HashtagDao">

	<!-- 관리용 -->
	
  	<!-- 해시태그 전체목록 -->
	<select id="selectList" parameterType="Map" resultType="hashtag">
		select * from hashtag
	</select>
  	
  	<!-- 단건 작성 -->
	<insert id="insertOne" parameterType="hashtag">
		insert into hashtag(hashtag_name, hashtag_time) 
		values (#{ hashtag_name }, now())
	</insert>
	
	<!-- 단건 조회 -->
	<select id="selectOne" parameterType="int" resultType="hashtag">
	    select * from hashtag where hashtag_idx = #{ hashtag_idx }
	</select>
	
	
  	<!-- 직접적인 삭제 -->
  	<delete id="delete" parameterType="int">
  		delete from hashtag where hashtag_idx = #{ hashtag_idx }
  	</delete>
  	
	<!-- 해시태그 작성용 -->
	
	<!-- 1. 중복검사용 list select -->
  	<select id="selectByNames" parameterType="list" resultType="hashtag">
  	select * from hashtag where hashtag_name in
  		<foreach collection="list" item="name" open="(" separator="," close=")">
  			#{ name }
  		</foreach>
  	</select>
	
	<!-- 2. 없다면 생성 -->
  	<insert id="insert" parameterType="list">
  	insert into hashtag (hashtag_name, hashtag_time) values
  		<foreach collection="list" item="name" separator=",">
  			( #{ name } , now() )
  		</foreach>
  	</insert>
  	
  	<!-- 3-1. 글쓰기 시 일괄등록 (POST용) -->
  	<insert id="insertPostHashtag" parameterType="Map">
  		insert into post_hashtag (post_idx, hashtag_idx) values
  		<foreach collection="hashtag_list" item="hashtag" separator=",">
  			( #{ post_idx }, #{ hashtag.hashtag_idx } )
  		</foreach>
  	</insert>
  	
  	<!-- 3-2. 상품 등록 시 일괄등록 (PRODUCT용) -->
  	<insert id="insertProductHashtag" parameterType="Map">
  		insert into product_hashtag (product_idx, hashtag_idx) values
  		<foreach collection="hashtag_list" item="hashtag" separator=",">
  			( #{ product_idx }, #{ hashtag.hashtag_idx } )
  		</foreach>
  	</insert>
  	
  	<!-- 4-1. post_hashtag 라인 삭제 -->
  	<delete id="deletePostHashtagByPost" parameterType="int">
  		delete from post_hashtag where post_idx = #{ post_idx }
  	</delete>
  	
  	<!-- 4-2. product_hashtag 라인 삭제 -->
  	<delete id="deleteProductHashtagByProduct" parameterType="int">
  		delete from product_hashtag where product_idx = #{ product_idx }
  	</delete>
  	
  	<!-- 각 서비스별 기능 -->
  	
  	<!-- 게시글의 해시태그 출력 (커뮤니티 목록 작은창 출력, 게시글 상세, 게시글 수정) -->
  	<select id="selectHashNamesByPost" parameterType="int" resultType="String">
	  	select hashtag_name from hashtag h
	  	inner join post_hashtag ph on h.hashtag_idx = ph.hashtag_idx
	  	where ph.post_idx = #{post_idx}
	  	order by h.hashtag_name
  	</select>
  	
  	<!-- 상품의 해시태그 출력 -->
  	<select id="selectHashNamesByProduct" parameterType="int" resultType="String">
	  	select hashtag_name from hashtag h
	  	inner join product_hashtag prh on h.hashtag_idx = prh.hashtag_idx
	  	where prh.product_idx = #{product_idx}
	  	order by h.hashtag_name
  	</select>
  	
  	<!-- 해시태그 idx 조회 -->
  	<select id="selectByIdx" parameterType="int" resultType="int">
		select ph.hashtag_idx
		from post_hashtag ph
		where ph.post_idx = #{post_idx}
  	</select>
  	
  	<!-- 해시태그 클릭 시 상품 조회 -->
  	<select id="selectProductByHashtag" parameterType="int" resultType="int">
  		select product_idx
  		from product_hashtag
  		where hashtag_idx = #{hashtag_idx}
  		<!-- 최신순, 찜순, 가격순 
  		order by --> 
  	</select>
  	
  	<!-- 해시태그 클릭 시 글 조회 -->
  	<select id="selectPostByHashtag" parameterType="int" resultType="int">
  		select post_idx
  		from post_hashtag
  		where hashtag_idx = #{hashtag_idx}
  		<!-- 좋아요 순, 리뷰 여부, 최신순 
  		order by --> 
  	</select>

  	<!-- 문진결과(상품) -->
  	<select id="selectProductsByHashtags" parameterType="Map" resultType="int">
  		select prh.product_idx, count(distinct prh.hashtag_idx) as match_count
  		from product_hashtag prh
  		where prh.hashtag_idx in
  		<foreach collection="hashtag_list" item="idx" open="(" separator="," close=")">
  		 	#{idx}
  		</foreach>
  		group by prh.product_idx
  		having match_count >= #{min_match}
  		order by match_count desc
  		<if test="limit!=null">
  			limit #{limit}
  		</if>
  	</select>

  	<!-- 문진 결과(포스팅) -->
  	<select id="selectPostsByHashtags" parameterType="Map" resultType="int">
		select ph.post_idx, count(distinct ph.hashtag_idx) as match_count
  		from post_hashtag ph
  		where ph.hashtag_idx in
  		<foreach collection="hashtag_list" item="idx" open="(" separator="," close=")">
  		 	#{idx}
  		</foreach>
  		group by ph.post_idx
  		having match_count >= #{min_match}
  		order by match_count desc
  		<if test="limit!=null">
  			limit #{limit}
  		</if>
  	</select>
  	
  	<!-- post 와 product에서 해시태그 카운트 한후 합산해서 hashtag 테이블에 update 시킴 -->
 	<select id="updatePostProductHashtagTotalConut">
 		UPDATE hashtag h
		JOIN (
		    SELECT hashtag_idx, SUM(cnt) AS total_count
		    FROM (
		        -- post_hashtag 카운트
		        SELECT hashtag_idx, COUNT(*) AS cnt
		        FROM post_hashtag
		        GROUP BY hashtag_idx
		        UNION ALL
		        -- product_hashtag 카운트
		        SELECT hashtag_idx, COUNT(*) AS cnt
		        FROM product_hashtag
		        GROUP BY hashtag_idx
		    ) AS combined
		    GROUP BY hashtag_idx
		) AS counts
		ON h.hashtag_idx = counts.hashtag_idx
		SET h.use_count = counts.total_count
		WHERE h.hashtag_idx IN (SELECT hashtag_idx FROM (
		    SELECT hashtag_idx FROM post_hashtag
		    UNION
		    SELECT hashtag_idx FROM product_hashtag
		) AS tmp);
 	</select>
 	
 	<!-- hashtag 테이블 use_count 순서대로 1~5위까지 가져오기 -->
 	<select id="selectHashtagRank" resultType="hashtag">
 		SELECT h.*
		FROM
		(SELECT
			hashtag_name,
		    hashtag_idx,
		    use_count,
		    ROW_NUMBER() OVER (ORDER BY use_count DESC) AS rank_num
		FROM hashtag) h
		WHERE rank_num IN (1,2,3,4);
 	</select>

</mapper>