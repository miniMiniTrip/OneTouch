<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.onetouch.dao.HashtagDao">

	<!-- 조회용 -->
	
  	<!-- 해시태그 전체목록 -->
	<select id="selectList" parameterType="Map" resultType="hashtag">
		select * from hashtag
	</select>
  	
  	<!-- 게시글의 해시태그 출력 (커뮤니티 목록 작은창 출력, 게시글 상세, 게시글 수정) -->
  	<select id="selectHashNamesByPost" parameterType="int" resultType="String">
	  	select hashtag_name from hashtag h
	  	inner join post_hashtag ph on h.hashtag_idx = ph.hashtag_idx
	  	where ph.post_idx = #{post_idx}
	  	order by h.hashtag_name
  	</select>
  	
  	<!-- 해시태그 idx 조회 -->
  	<select id="selectByIdx" parameterType="int" resultType="int">
		select ph.hashtag_idx
		from post_hashtag ph
		where ph.post_idx = #{post.idx}
  	</select>
  	
  	<!-- 해시태그 클릭 시 상품 조회 -->
  	<select id="selectProductByHashtag" parameterType="int" resultType="int">
  		select product_idx
  		from product_hashtag
  		where hashtag_idx = #{hashtag_idx}
  		<!-- 최신순, 찜순, 가격순 
  		order by --> 
  	</select>
  	
  	<!-- 해시태그 클릭 시 글 조회 -->
  	<select id="selectPostByHashtag" parameterType="int" resultType="int">
  		select post_idx
  		from post_hashtag
  		where hashtag_idx = #{hashtag_idx}
  		<!-- 좋아요 순, 리뷰 여부, 최신순 
  		order by --> 
  	</select>

  	<!-- 문진결과(상품) -->
  	<select id="selectProductByHashtag" parameterType="map" resultType="int">
  		select prh.product.idx count(distinct ph.hashtag_idx) as match
  		from product_hashtag prh
  		where prh.hashtag_idx in
  		<foreach collection="hashtag_list" item="idx" open="(" separator="," close=")">
  		 	#{idx}
  		</foreach>
  		group by prh.product_idx
  		having match >= #{min_match}
  		order by match desc
  		<if test="limit!=null">
  			limit #{limit}
  		</if>
  	</select>

  	<!-- 문진 결과(포스팅) -->
  	<select id="selectPostByHashtag" parameterType="map" resultType="int">
  		select ph.post.idx count(distinct ph.hashtag_idx) as match
  		from post_hashtag ph
  		where ph.hashtag_idx in
  		<foreach collection="hashtag_list" item="idx" open="(" separator="," close=")">
  		 	#{idx}
  		</foreach>
  		group by ph.post_idx
  		having match >= #{min_match}
  		order by match desc
  		<if test="limit!=null">
  			limit #{limit}
  		</if>
  	</select>
  	
	<!-- 해시태그 작성용 -->
	
	<!-- 1. 중복검사용 list select -->
  	<select id="selectByNames" parameterType="list" resultType="hashtag">
  	select * from hashtag where hashtag_name in
  		<foreach collection="list" item="name" open="(" separator="," close=")">
  			#{ name }
  		</foreach>
  	</select>
	
	<!-- 2. 없다면 생성 -->
  	<insert id="insert" parameterType="hashtag">
  	insert into hashtag (hashtag_name, hashtag_time) values
  		<foreach collection="list" item="name" separator=",">
  			( #{ name } , now() )
  		</foreach>
  	</insert>
  	
  	<!-- 글쓰기 시 일괄등록 -->
  	<insert id="insertPostHashtag" parameterType="map">
  		insert into post_hashtag (post_idx, hashtag_idx) values
  		<foreach collection="hashtag_list" item="hashtag" separator=",">
  			( #{ post_idx }, #{ hashtag_idx } )
  		</foreach>
  	</insert>
 
  	<!-- 직접적인 삭제 -->
  	<delete id="delete" parameterType="int">
  	delete from hashtag where hashtag_idx = #{ hashtag_idx }
  	</delete>

</mapper>