<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.onetouch.dao.PostDao">
	
	<resultMap id="PostResultMap" type="PostVo" >
		<id property="post_idx" column="post_idx"/>
	    <result property="mem_idx" column="mem_idx"/>
	    <result property="mem_id" column="mem_id"/>
	    <result property="mem_image_url" column="mem_image_url"/>
    	<result property="post_category" column="post_category"/>
    	<result property="post_title" column="post_title"/>
	    <result property="post_content" column="post_content"/>
	    <result property="post_image" column="post_image"/>
	    <result property="post_like" column="post_like"/>
	    <result property="post_comment_count" column="post_comment_count"/>
	    <result property="order_id" column="order_id"/>
	    <result property="post_review" column="post_review"/>
	    <result property="post_rating" column="post_rating"/>
	    <result property="post_delete" column="post_delete"/>
	    <result property="post_time" column="post_time"/>
	    <result property="post_update" column="post_update"/>
	    
		<collection property="productList" ofType="com.onetouch.vo.ProductVo">
			<id property="product_idx" column="product_idx"/>
			<result property="product_name" column="product_name"/>
			<result property="product_price" column="product_price"/>
	   		<result property="product_image_url" column="product_image_url"/>
		</collection>
		<collection property="likeList" ofType="com.onetouch.vo.LikeVo">
			<result property="like_idx" column="like_idx"/>
			<result property="post_idx" column="like_post_idx"/>
			<result property="mem_idx" column="like_mem_idx"/>
			<result property="like_time" column="like_time"/>
		</collection>
		<collection property="replyList" ofType="com.onetouch.vo.ReplyVo">
			<result property="reply_idx" column="reply_idx"/>
			<result property="mem_idx" column="mem_idx"/>
			<result property="mem_id" column="mem_id"/>
			<result property="post_idx" column="post_idx"/>
			<result property="reply_content" column="reply_content"/>
			<result property="reply_delete" column="reply_delete"/>
			<result property="reply_time" column="reply_time"/>
			<result property="reply_update" column="reply_update"/>
		</collection>
		<collection property="hashtagList" ofType="com.onetouch.vo.HashtagVo">
			<result property="hashtag_idx" column="hashtag_idx"/>
			<result property="hashtag_name" column="hashtag_name"/>
		</collection>
	</resultMap>
	<!-- post 전체 조회 -->
	<select id="selectPostList" resultMap="PostResultMap">
	    SELECT 
	        p.*, m.mem_id, m.mem_image_url
	        ,pr.product_idx, pr.product_name, pr.product_price
	        ,pi.product_image_url
	        , l.like_idx ,l.post_idx as like_post_idx,l.mem_idx as like_mem_idx,l.like_time
	        , r.*
	        , ph.hashtag_idx
	        , h.hashtag_name
	    FROM post p
	    JOIN mem m ON p.mem_idx = m.mem_idx
	    LEFT JOIN post_product pp ON p.post_idx = pp.post_idx
	    LEFT JOIN product pr ON pp.product_idx = pr.product_idx
	    LEFT JOIN product_image pi ON pp.product_idx =pi.product_idx
	    LEFT JOIN `like` l ON p.post_idx = l.post_idx
	    LEFT JOIN reply as r on p.post_idx=r.post_idx
	    LEFT JOIN post_hashtag as ph on p.post_idx = ph.post_idx
	    LEFT JOIN hashtag as h on ph.hashtag_idx=h.hashtag_idx
	    <if test="postPageVo !=null and postPageVo.size()>0">
	    WHERE p.post_idx IN
	    <if test="postsList ==null">
		    <foreach collection="postPageVo" item="vo" open="(" separator="," close=")">
		    	#{vo.post_idx}
		    </foreach>
	    </if>
	    <if test="postsList !=null">
		    <foreach collection="postsList" item="post_idx" open="(" separator="," close=")">
		    	#{post_idx}
		    </foreach>
	    </if>
	    </if>
	    <if test="postPageVo ==null or postPageVo.size() == 0">
	    WHERE 1=0
	    </if>
	    ORDER BY p.post_idx DESC,r.reply_idx DESC
	</select>
	
	<!-- 페이지 처리를 위한 post_idx list 가져오기 -->
	<select id="selectPostIdxList" parameterType="map" resultType="PostPageVo">
	SELECT p.post_idx
	FROM post p
	where 1=1	
	<if test="post_category != null and post_category != '' and post_category != 'all'">
	and post_category=#{post_category}
	</if>
	<if test="mypage=='mypost'">
	AND mem_idx=#{login_mem_idx}
	</if>
	ORDER BY p.post_idx DESC
	LIMIT #{page}, #{block_list};
	</select>
	
	<!-- 스킨 list -->
	<select id="selectTipList" resultMap="PostResultMap">
		SELECT
			p.*,m.mem_id 
		   ,m.mem_image_url
		   ,pr.product_idx, pr.product_name, pr.product_price
	       ,pi.product_image_url
    	   , l.like_idx ,l.post_idx as like_post_idx,l.mem_idx as like_mem_idx,l.like_time
    	   , r.*
    	   , ph.hashtag_idx
	       , h.hashtag_name
		FROM otdb.post as p
		join mem as m ON p.mem_idx=m.mem_idx
	    LEFT JOIN post_product pp ON p.post_idx = pp.post_idx
	    LEFT JOIN product pr ON pp.product_idx = pr.product_idx
	    LEFT JOIN product_image pi ON pp.product_idx =pi.product_idx
	     LEFT JOIN `like` l 
        	ON p.post_idx = l.post_idx
        LEFT join reply as r on p.post_idx=r.post_idx
        LEFT JOIN post_hashtag as ph on p.post_idx = ph.post_idx
	    LEFT JOIN hashtag as h on ph.hashtag_idx=h.hashtag_idx
		WHERE post_category='skin' 
		<if test="postPageVo !=null and postPageVo.size()>0">
		and
		p.post_idx IN
	    <foreach collection="postPageVo" item="vo" open="(" separator="," close=")">
	    	#{vo.post_idx}
	    </foreach> 
	    </if>
	    <if test="postPageVo ==null or postPageVo.size() == 0">
	    and 1=0
	    </if>	
		ORDER BY p.post_idx DESC,r.reply_idx DESC
	</select>
	
	<!-- 리뷰 목록 -->
	<select id="selectReviewList" resultMap="PostResultMap">
		SELECT p.*,m.mem_id 
		,m.mem_image_url
		, l.like_idx ,l.post_idx as like_post_idx,l.mem_idx as like_mem_idx,l.like_time
		, r.*
		, ph.hashtag_idx
	    , h.hashtag_name
		FROM otdb.post as p
		join mem as m
		ON p.mem_idx=m.mem_idx
		LEFT JOIN `like` l ON p.post_idx = l.post_idx
		LEFT join reply as r on p.post_idx=r.post_idx
		LEFT JOIN post_hashtag as ph on p.post_idx = ph.post_idx
	    LEFT JOIN hashtag as h on ph.hashtag_idx=h.hashtag_idx
		WHERE post_category='review' 
		<if test="postPageVo !=null and postPageVo.size()>0">
		and
		p.post_idx IN
	    <foreach collection="postPageVo" item="vo" open="(" separator="," close=")">
	    	#{vo.post_idx}
	    </foreach>
	    </if>	
   	    <if test="postPageVo == null or postPageVo.size() == 0">
		  and 1=0
		</if>
		ORDER BY p.post_idx DESC,r.reply_idx DESC
	</select>
	
	<!-- 자유 목록 -->
	<select id="selectFreeBoard" resultMap="PostResultMap">
		SELECT p.*,m.mem_id 
		,m.mem_image_url
		, l.like_idx ,l.post_idx as like_post_idx,l.mem_idx as like_mem_idx,l.like_time
		, r.*
		, ph.hashtag_idx
	    , h.hashtag_name
		FROM otdb.post as p
		join mem as m
		ON p.mem_idx=m.mem_idx
		LEFT JOIN `like` l ON p.post_idx = l.post_idx
		LEFT join reply as r on p.post_idx=r.post_idx
		LEFT JOIN post_hashtag as ph on p.post_idx = ph.post_idx
	    LEFT JOIN hashtag as h on ph.hashtag_idx=h.hashtag_idx
		WHERE post_category='free' 
		<if test="postPageVo !=null and postPageVo.size()>0">
		and
		p.post_idx IN
	    <foreach collection="postPageVo" item="vo" open="(" separator="," close=")">
	    	#{vo.post_idx}
	    </foreach>	
	    </if>
	    <if test="postPageVo == null or postPageVo.size() == 0">
		  and 1=0
		</if>
		ORDER BY p.post_idx DESC,r.reply_idx DESC
	</select>
	
	<insert id="postInsert" parameterType="PostVo" useGeneratedKeys="true" keyProperty="post_idx">
		INSERT INTO post (post_idx,mem_idx,post_category,post_title,post_content,post_time,post_update,post_image,post_rating,order_item_id)
					VALUES(null,#{mem_idx},#{post_category},#{post_title},#{post_content},now(),now(),#{post_image},#{post_rating},#{order_item_id})
	</insert>
		
	<!-- post_product 테이블에 post_idx,product_idx 등록 -->
	<insert id="postProductInsert" parameterType="PostVo">
		insert into post_product
			(post_product_idx,post_idx,product_idx)
		values
			(null,#{post_idx},#{product_idx})
	</insert>
	
	<!-- post 등록페이지에서 product list 불러오기 -->
	<select id="selectProductList">
	 select * from product
	 	order by product_idx desc
	</select>
	
	<!-- post 관련해서 like 테이블에 좋아요 추가 -->
	<insert id="insertPostLike" parameterType="map">
		insert into `like`(like_idx,post_idx,mem_idx,like_time)
					 values(null,#{post_idx},#{mem_idx},now())
	</insert>
	
	<select id="selectLikePostIdxOne" parameterType="map" resultType="LikeVo">
		select * from `like` where post_idx=#{post_idx} and mem_idx=#{mem_idx}
	</select>
	
	<delete id="deletePostLike" parameterType="map">
		delete FROM `like` WHERE post_idx=#{post_idx} and mem_idx=#{mem_idx}
	</delete>
	
	<!-- 좋아요 갯수 카운트 -->
	<select id="selectLikeCount" parameterType="map" resultType="int">
		select count(*) from `like` where post_idx = #{post_idx}
	</select>
	
	<!-- 좋아요 저장 -->
	<update id="updatePostLikeCount" parameterType="map" >
		UPDATE post SET post_like = #{post_like} WHERE post_idx=#{post_idx} 
	</update>
	
	<!-- post 테이블에서  post_idx 기준으로 1개 select -->
	<select id="selectPostOne" parameterType="int" resultType="PostVo">
		select p.* from post as p where post_idx=#{post_idx}
	</select>
	<!-- post_product 테이블에서 post_idx 기준으로 1개 select -->
	<select id="selectPostProductOne" parameterType="int" resultType="PostProductVo">
		select 
			pp.*
		from 
			post_product as pp
		where pp.post_idx= #{post_idx}
	</select>
	
	<!-- post review 수정 -->
	<update id="updatePostVo" parameterType="PostVo">
		update post
		set 
		post_title = #{post_title}
		,post_content = #{post_content}
		,post_rating=#{post_rating}
		,post_image=#{post_image}
		where post_idx=#{post_idx};
	</update>
	
	<!-- post_product 테이블에서 post_idx 기준으로 삭제-->
	<delete id="deletePostProduct" parameterType="int">
		delete from post_product where post_idx=#{post_idx}
	</delete>
	
	<!-- post 테이블에서 post_idx 기준으로 1개 삭제 -->
	<delete id="deletePost" parameterType="int">
		delete from post WhERE post_idx=#{post_idx}
	</delete>
	
	<!-- post Total Count (페이지 처리를 위한 sql) -->
	<select id="selectPostTotalCount" resultType="int" parameterType="map">
	    SELECT COUNT(p.post_idx) as postTotalCount
	    FROM post p
	    <where>
	        <if test="post_category != 'all'">
	            p.post_category = #{post_category}
	        </if>
	
	        <if test="mypage == 'mypost'">
	            AND p.mem_idx = #{login_mem_idx}
	        </if>
	    </where>
	</select>
	
	<!-- order 테이블과 order_item -->
	<select id="selectReviewOrderOne" parameterType="map" resultType="ReviewVo">
	    SELECT 
	        o.order_id, o.mem_idx, oi.order_item_id, oi.product_idx, oi.product_name
	    FROM otdb.order as o
	    JOIN order_item as oi 
	    WHERE o.order_id=oi.order_id 
	    and o.mem_idx = #{mem_idx} 
	    and oi.product_idx = #{product_idx}
	    <if test="order_item_id != null and order_item_id > 0">
	    and oi.order_item_id = #{order_item_id}
	    </if>
	    LIMIT 1
	</select>
	<!-- sw: order_item_id로 해당 아이템만 조회하도록 함
			 limit 1은 한번만 작성할 수 있게 처리하는 장치 -->
	
	
	<select id="selectByIds" parameterType="list" resultMap="PostResultMap">
	    SELECT 
	        p.*, m.mem_id, m.mem_image_url
	        , l.like_idx, l.post_idx as like_post_idx, l.mem_idx as like_mem_idx, l.like_time
	        , ph.hashtag_idx
	        , h.hashtag_name
	    FROM post p
	    JOIN mem m ON p.mem_idx = m.mem_idx
	    LEFT JOIN `like` l ON p.post_idx = l.post_idx
	    LEFT JOIN post_hashtag as ph on p.post_idx = ph.post_idx
	    LEFT JOIN hashtag as h on ph.hashtag_idx = h.hashtag_idx
	    WHERE p.post_idx IN
	    <foreach collection="list" item="id" open="(" separator="," close=")">
	        #{id}
	    </foreach>
	    ORDER BY p.post_idx DESC
	</select>
	
	<select id="selectPostOrderItemOne" resultType="PostVo">
		SELECT * FROM otdb.post
		WHERE order_item_id=#{order_item_id};
	</select>
	
	<!-- 상세페이지에서 리뷰처리를 위한 코드 -->
	<select id="selectReviewPostList" parameterType="int" resultType="OrderReviewPostVo">
		SELECT 
		o.order_id as order_id
		,o.order_no as order_no
		,o.mem_idx as mem_idx
		,m.mem_image_url as mem_image_url
		,m.mem_id as mem_id
		,o.order_status as order_status
		,oi.product_name as product_name
		,oi.product_idx as product_idx
		,o.order_time as order_time
		,o.total_amount as total_amount
		,o.order_address as order_address
		,p.order_item_id as order_item_id
		,p.post_rating as post_rating
		,p.post_image as post_image
		,p.post_title as post_title
		,p.post_content as post_content
		,p.post_time as post_time
		FROM 
		otdb.order o
		LEFT JOIN order_item oi ON o.order_id = oi.order_id
		LEFT JOIN mem m ON o.mem_idx = m.mem_idx
		LEFT JOIN post p ON p.order_item_id = oi.order_item_id
		WHERE product_idx = #{product_idx}
		ORDER BY o.order_time desc
		;
	</select>
	
	<!-- 키워드로 셀렉트 -->
	<select id="searchByKeyword" resultType="PostVo">
	    SELECT 
	        p.*,
	        m.mem_id,
	        m.mem_image_url,
	        COALESCE(lc.like_count, 0) as post_like,
	        COALESCE(rc.reply_count, 0) as post_comment_count
	    FROM post p
	    LEFT JOIN mem m ON p.mem_idx = m.mem_idx
	    LEFT JOIN (
	        SELECT post_idx, COUNT(*) as like_count 
	        FROM `like`
	        GROUP BY post_idx
	    ) lc ON p.post_idx = lc.post_idx
	    LEFT JOIN (
	        SELECT post_idx, COUNT(*) as reply_count 
	        FROM reply 
	        WHERE reply_delete = 0
	        GROUP BY post_idx
	    ) rc ON p.post_idx = rc.post_idx
	    WHERE p.post_delete = 0
	      AND (
	          p.post_title LIKE CONCAT('%', #{keyword}, '%')
	          OR p.post_content LIKE CONCAT('%', #{keyword}, '%')
	          OR EXISTS (
	              SELECT 1 
	              FROM post_hashtag ph
	              INNER JOIN hashtag h ON ph.hashtag_idx = h.hashtag_idx
	              WHERE ph.post_idx = p.post_idx
	                AND h.hashtag_name LIKE CONCAT('%', #{keyword}, '%')
	          )
	      )
	    ORDER BY p.post_time DESC
	    LIMIT #{startRow}, #{pageSize}
	</select>

	
	<!-- 포스트 결과 개수 -->
	<select id="searchCount" resultType="int">
	    SELECT COUNT(*)
	    FROM post p
	    WHERE p.post_delete = 0
	      AND (
	          p.post_title LIKE CONCAT('%', #{keyword}, '%')
	          OR p.post_content LIKE CONCAT('%', #{keyword}, '%')
	          OR EXISTS (
	              SELECT 1 
	              FROM post_hashtag ph
	              INNER JOIN hashtag h ON ph.hashtag_idx = h.hashtag_idx
	              WHERE ph.post_idx = p.post_idx
	                AND h.hashtag_name LIKE CONCAT('%', #{keyword}, '%')
	          )
	      )
	</select>

</mapper>